@using Kendo.Mvc.UI
@model PATSWebV2.ViewModels.SocialWork.IRPViewModel

@using (Ajax.BeginForm("SaveClinicalIRP", "Client", null, new AjaxOptions
{
    HttpMethod = "Post",
    UpdateTargetId = "viewPlaceHolder",
    InsertionMode = InsertionMode.Replace,
    OnSuccess = "OnAjaxSuccess"
}, new
{
    @id = "irpform",
    @name = "Case Management Individualized Re-entry Plan",
    @style = "min-height: 500px;overflow:hidden;",
    @class = "color-danger"
}))
{
    <div id="appointmentdiv" class="color-danger" style="height:100%;min-width:1200px;width:99.5%">
        @Html.HiddenFor(m => m.EpisodeID, new { id = "hdEpisodeID" })
        @Html.HiddenFor(m => m.CanEdit, new { @id = "hdEditable" })
        @Html.HiddenFor(m => m.IRPSetList[0].IsLastIRPSet, new { id = "hdIsLastIRPSet" })
        @{
            var show = (Model.IRPSetList != null && Model.IRPSetList[0].IRPId > 0) ? "visible" : "hidden";
        }
        <table style="background-color:transparent;min-width:600px">
            <tr>
                <td style="width:55vw;">
                        <table>
                            <tr style="line-height: 10px !important;"><td id="customers">@Html.Label("STATE OF CALIFORNIA", new { style = "float:left;font-size:12px;" })</td></tr>
                            <tr style="line-height: 10px !important;"><td>@Html.Label("CASE MANAGEMENT INDIVIDUALIZED RE-ENTRY PLAN", new { style = "float:left;font-weight:bold;font-size:14px;" })&nbsp;&nbsp;@Model.NoEditAllowed</td></tr>
                            <tr style="line-height: 10px !important;">
                                <td>
                                    @Html.Label("CDCR 2276(11/14)", new { style = "float:left;font-size:12px;" })&nbsp;&nbsp;
                                <a style="visibility:@show;" href="javascript:printPATSPDF(@Model.EpisodeID, @Model.IRPSetList[0].IRPId, 'Case Managemnent Individualized Re-entry Plan','color-danger')">
                                    <img style="width:22px; height:22px;margin-top:-5px;" title="Print Case IRP" src='@Url.Content("~/Content/images/printer-icon.png")' /></a>&nbsp;&nbsp;@Model.NoEditAllowed
                            </td>
                        </tr>
                    </table>
                </td>
                <td style="width:50vw;">
                    <table id="gird" class="k-grid table-bordered" style="width:100%;background-color:white; min-width:600px;">
                        <tr style="background-color:silver;height:10px!important;font-size:small;text-align:center;border-color:black" class="k-grid-header k-header table-bordered">
                            <th style="text-align:left;height:11px!important;width:100px;font-size:10px">IRP DATE:</th>
                            <th style="text-align:left;height:11px!important;width:250px;font-size:10px">PROGRAM PHASE:</th>
                            <th style="text-align:left;height:11px!important;font-size:10px">RATER:</th>
                        </tr>
                        <tr style="text-align:left;">
                            <td style="font-size:11px">
                                <script>
                                    var edit = ($("#hdIsLastIRPSet").val() == "True" && $("#hdEditable").val() == "True");
                                    $('#irpform').on('dblclick', '.textareaforcasemanngement', function (e) {
                                        TextarePopup(e, edit, "color-danger");
                                    });
                                    $('#irpform').on('keyup', '.textareaforcasemanngement', function (e) {
                                        if (e.keyCode == '90' && e.ctrlKey) {
                                            $(this).trigger('dblclick');
                                        }
                                    })
                                    function PopulatePreviousIRPSet(e) {
                                        if (this.select() == 0) {
                                            DisableAllInputFields("#irpform :input", $("#hdEditable").val(), false);
                                            return;
                                        }
                                        var object = this.dataItem(this.select());
                                        var id = (object == undefined || object.IRPID == "") ? 0 : object.IRPID;
                                        $.ajax({
                                            url: "@Url.Action("GetIRP", "Client")",
                                            data: {
                                                EpisodeID: $("#hdEpisodeID").val(), IRPID: id },
                                        cache: false,
                                        type: "POST",
                                        dataType: "html",

                                        success: function (data, textStatus, XMLHttpRequest) {
                                            $("#irpform").replaceWith(data); // HTML DOM replace
                                        }
                                    })
                                    }
                                </script>
                                @(Html.Kendo().DropDownListFor(m => m.IRPSetList[0].IRPId)
                .Name("AllIRPDates")
                .OptionLabel("Select Dates...")
                .DataTextField("IRPDate")
                .DataValueField("IRPID")
                .HtmlAttributes(new { style = "width:120px;text-align:left;", @class = "neverDisable" })
                .Filter(FilterType.Contains)
                .Height(290)
                .Events(e => { e.Change("PopulatePreviousIRPSet"); })
                .DataSource(source =>
                {
                    source.Read(read => read.Action("GetIRPDateList", "Client", new { EpisodeID = Model.EpisodeID }));
                }))
                            </td>
                            <td style="font-size:11px">@Html.DisplayFor(m => m.IRPSetList[0].IDTTDecision)</td>
                            <td style="font-size:11px">@Html.DisplayFor(m => m.ActionUserName)</td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
        @*<div class="color-warning" style="min-width:1200px;overflow:auto;width:100%">*@
        <table id="gird" class="k-grid" style="background-color:white;min-width:1200px;width:99.8%;">
            <tr style="background-color:silver;font-size:small;text-align:center" class="k-grid-header k-header table-bordered">
                <th rowspan="2" style="text-align:center; width:400px">PRESENTING NEED</th>
                <th colspan="4" style="text-align:center">NEED</th>
                <th colspan="2" style="text-align:center">GOAL</th>
                <th rowspan="2" style="text-align:center">PLANNED INTERVENTION</th>
                <th colspan="3" style="text-align:center">LONG TERM STATUS</th>
                @*<th class="col-xs-1" rowspan="2" style="text-align:center">STATUS D</th>*@
            </tr>
            <tr style="text-align:center; background-color:silver;font-size:small;" class="k-grid-header k-header table-bordered">
                <th style="width:50px;text-align:center">NO</th>
                <th style="width:50px;text-align:center">LOW</th>
                <th style="width:50px;text-align:center">MOD</th>
                <th style="width:50px;text-align:center">HI/URG</th>
                <th style="text-align:center">SHORT TERM</th>
                <th style="text-align:center">LONG TERM</th>
                <th style="width:50px;text-align:center">MET</th>
                <th style="width:50px;text-align:center">NOT MET</th>
                <th style="width:110px;text-align:center">DATE</th>
            </tr>
            @for (int i = 0; i < Model.IRPSetList.Count; i++)
            {
                <tr>
                    @Html.HiddenFor(m => m.IRPSetList[i].NeedId)
                    <td valign="top" style="line-height:14px;">
                           <div style="font-size:12px;line-height:14px;">
                            @Html.Raw(string.Format("<b>{0}.   {1}</b>", Model.IRPSetList[i].NeedId, Model.IRPSetList[i].Need))
                           </div> 
                            <br />
                            <div style="font-size:12px;margin-top:2px;">
                                @Html.Raw(string.Format("{0}", Convert.ToString(Model.IRPSetList[i].DescriptionCurrentNeed)))
                            </div>
</td>
                    <td>&nbsp;@(Html.Kendo().CheckBoxFor(m => m.IRPSetList[i].NeedStatus1).HtmlAttributes(new { @style = "text-align:center", @class = "needStatus" }))</td>
                    <td>&nbsp;@(Html.Kendo().CheckBoxFor(m => m.IRPSetList[i].NeedStatus2).HtmlAttributes(new { @class = "needStatus" }))</td>
                    <td>&nbsp;@(Html.Kendo().CheckBoxFor(m => m.IRPSetList[i].NeedStatus3).HtmlAttributes(new { @class = "needStatus" }))</td>
                    <td>&nbsp;@(Html.Kendo().CheckBoxFor(m => m.IRPSetList[i].NeedStatus4).HtmlAttributes(new { @class = "needStatus" }))</td>

                    <td style="line-height:14PX;">@Html.TextAreaFor(m => m.IRPSetList[i].ShortTermGoal, new { @spellcheck = "true", @class = "textareaforcasemanngement", @placeholder = "Short Term Goal ...", @maxLength = "100" })</td>
                    <td style="line-height:14PX;">@Html.TextAreaFor(m => m.IRPSetList[i].LongTermGoal, new { @spellcheck = "true", @class = "textareaforcasemanngement", @placeholder = "Long Term Goal ...", @maxLength = "100" })</td>
                    <td style="line-height:14PX;">@Html.TextAreaFor(m => m.IRPSetList[i].PlanedIntervention, new { @id = "txt" + @i, @refID = @i, @class = "textareaforcasemanngement", @placeholder = "Planned Intervention ...", @maxLength = "255" })</td>
                    <td style="line-height:14PX;">
                        &nbsp;@(Html.Kendo().CheckBoxFor(m => m.IRPSetList[i].LongTermStatusMet).Checked(Model.IRPSetList[i].LongTermStatusMet.Value).HtmlAttributes(new { @class = "ltermStatus" }))
                    </td>
                    <td>
                        &nbsp;@(Html.Kendo().CheckBoxFor(m => m.IRPSetList[i].LongTermStatusNoMet).Checked(Model.IRPSetList[i].LongTermStatusNoMet.Value).HtmlAttributes(new { @class = "ltermStatus" }))
                    </td>
                    <td>
                        @(Html.Kendo().DatePickerFor(m => m.IRPSetList[i].LongTermStatusDate).Format("MM/dd/yyyy").Value(Model.IRPSetList[i].LongTermStatusDate.HasValue ? Model.IRPSetList[i].LongTermStatusDate.Value.ToString("MM/dd/yyyy") : null).HtmlAttributes(new
            {
                @style = "width:120px",
                @id = "date-picker-irp-" + Model.IRPSetList[i].NeedId,
                @class = "input-group irpdp"
            }))

                    </td>
                </tr>
            }
        </table>
    </div>
            <br />
            <div class="padded aligncenter form-actions" id="caseIRPButtonDiv">
                @if (Model.CanEdit)
                {
                    <button type="submit" class="btn btn-group-lg danger-button" id="irpSave">Submit</button>
                }&nbsp;&nbsp;
                <button type="button" class="btn btn-group-lg danger-button" id="irpCancel">Cancel</button>
                <button type="button" class="btn btn-group-lg danger-button" id="irpReset">Reset</button>&nbsp;&nbsp;
                @if ((Model.IRPSetList != null && Model.IRPSetList.Count() > 0 && Model.IRPSetList[0].IRPId > 0))
                {
                    <a href="javascript:printPATSPDF(@Model.EpisodeID, '@Model.IRPSetList[0].IRPId', 'Case Managemnent Individualized Re-entry Plan','color-danger')">
                        <img style="width:22px; height:22px;" title="Print Case IRP" src='@Url.Content("~/Content/images/printer-icon.png")'/></a>
                }
            </div>
            <br />
            @*</div>*@
}
<script type="text/javascript">
    function IRPButtonDisable(disabled) {
        $("#irpSave").prop('disabled', disabled);
        $("#irpCancel").prop('disabled', disabled);
        $("#irpReset").prop('disabled', disabled);
    }
    $(function () {
        var initdata = $('#irpform').serialize();  //AllArray();
        $('#irpform').submit(function (e) {
            e.preventDefault();
            var nowdata = $('#irpform').serialize();
            if (initdata === nowdata) {
                NoticeNoChanges();
                e.stopPropagation();
                return false;
            }
            if (confirm("Are you sure you want to save this IRP?") == false) {
                e.stopPropagation();
                return false;
            }
            initdata = nowdata;
            IRPButtonDisable(true);
            postFormAndReplaceDivHtmlPats($('#irpform'));
            var tabstrip = $("#swTabstrip").data("kendoTabStrip");
            var tab = tabstrip.select();
            tabstrip.reload(tab);
            return true;
        });
        $("#irpform :input").change(function (e) {
            var nowdata = $('#irpform').serialize();
            if (initdata === nowdata) {
                IRPButtonDisable(true);
            }
            else {
                IRPButtonDisable(false);
            }
        });
    });
    $(".irpdp").kendoValidator({
        rules: {
            dateValidation: function (element) {
                $(this).removeClass('field-validation-error');
                $(this).parent().find('span[data-valmsg-for]').remove();
                if (element.is("[data-val-date]") && element.val() != "") {
                    var value = $(element).val();
                    return is_valid_date(value);
                }
                return true;
            }
        },
        messages: {
            dateValidation: "must be a valid date",
        }
    });
    $(".irpdp").kendoMaskedTextBox({
        mask: "00/00/0000"
    });
    $(".irpdp").closest(".k-datepicker").add($(".irpdp")).removeClass("k-textbox")


    //$('#irpform').on('focus', '.textareaforcasemanngement', function (e) {
    //    ResizeTextArea($(this), e);
    //})
    //$('#irpform').on('blur', '.textareaforcasemanngement', function (e) {
    //    MinTextArea($(this), e, 30, this.maxLength);
    //})
    $(".needStatus").click(function (e) {
        if ($(this).prop('checked')) {
            var rownum = this.name.substring((this.name.indexOf('[') + 1), (this.name.indexOf(']')));
            var selectName = this.name;
            var statusid = this.name.substring(this.name.length - 1, this.name.length);
            $(".needStatus").each(function () {
               if (this.name.substring((this.name.indexOf('[') + 1), (this.name.indexOf(']'))) == rownum &&
                     this.name != selectName) {
                    $(this).prop('checked', false);
                }
            })
        }
    })
    $(".ltermStatus").click(function (e) {
        if ($(this).prop('checked')) {
            var rownum = this.name.substring((this.name.indexOf('[') + 1), (this.name.indexOf(']')));
            var selectName = this.name;
             $(".ltermStatus").each(function () {
                 if (this.name.substring((this.name.indexOf('[') + 1), (this.name.indexOf(']'))) == rownum &&
                     this.name != selectName) {
                    $(this).prop('checked', false);
                }
            })
        }
    })

    var editableIRP = EditableEpisode($("#hdEditable").val()) && $("#hdIsLastIRPSet").val() == "True";
    DisableAllInputFields("#irpform :input", $("#hdEditable").val(), editableIRP);
    IRPButtonDisable(true);
        $("#irpReset").click(function () {
            $("#irpform :input").each(function () {
                if (this.type == "checkbox" || this.type == "radio")
                    $(this).prop('checked', false);

                if (this.type == "text" || this.type == "textarea") {
                    $(this).val('');
                }

            })
        });

        $("#irpCancel").click(function () {
            document.getElementById("irpform").reset();
            IRPButtonDisable(true);
        })
</script>







