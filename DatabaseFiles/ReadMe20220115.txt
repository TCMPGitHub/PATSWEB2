1. Run spGetClientSummaryList
2. Run spGetEpisodeSummary
3. spCheckOccupied

USE [PATSWebV2]
GO

/****** Object:  Table [dbo].[CaseBHRIRP]    Script Date: 7/12/2022 9:22:00 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [dbo].[CaseBHRIRP](
	[IRPId] [int] IDENTITY(1,1) NOT NULL,
	[EpisodeID] [int] NOT NULL,
	[CurrentPhaseStatus] [int] NULL,
	[BHRIRPJson] [ntext] NULL,
	[AdditionalRemarks] [nvarchar](500) NULL,
	[ActionStatus] [int] NOT NULL,
	[ActionBy] [int] NOT NULL,
	[DateAction] [datetime] NOT NULL,
	[BassUserID] [int] NULL,
 CONSTRAINT [PK_dbo.CaseBHRIRP] PRIMARY KEY CLUSTERED 
(
	[IRPId] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]

GO

USE [PATSWebV2]
GO

/****** Object:  Index [IX_EpisodeID]    Script Date: 7/12/2022 9:23:11 AM ******/
CREATE NONCLUSTERED INDEX [IX_EpisodeID] ON [dbo].[CaseBHRIRP]
(
	[EpisodeID] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, SORT_IN_TEMPDB = OFF, DROP_EXISTING = OFF, ONLINE = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON) ON [PRIMARY]
GO

ALTER TABLE dbo.EpisodeTrace
ADD BHRIRPID INT NULL

USE [PATSWebV2Test]
GO

/****** Object:  StoredProcedure [dbo].[spGetEpisodeBHRIRP]    Script Date: 7/12/2022 9:33:36 AM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Create date: 2020-04-06
-- Description:	Get the Latest BHR IRP 
-- =============================================
CREATE PROCEDURE [dbo].[spGetEpisodeBHRIRP] 
	@EpisodeID int = null,
	@BHRIRPID int = 0, 
	@CurrentUserID int = 0
AS
BEGIN
   
 DECLARE @True BIT = 1
 DeCLARE @False BIT = 0
 DECLARE @IsLastBIRPSet bit
 DECLARE @LBIRPID  int = 0
 DECLARE @NeedsAssessmentID int = 0
  IF  @EpisodeID > 0 
   BEGIN
     SELECT @LBIRPID = ISNULl(BHRIRPID, 0), @NeedsAssessmentID = ISNULl(NeedsAssessmentID, 0)         FROM dbo.EpisodeTrace WHERE EpisodeID = @EpisodeID
	
	 IF @LBIRPID = @BHRIRPID OR @LBIRPID = 0
		     SET @IsLastBIRPSet = 1

	DECLARE  @CanEdit bit  = (SELECT (CASE WHEN ((IsPOCAdmin = 1 OR IsPOCSocialWorker = 1)) THEN 1 ELSE 0 END ) FROM [User] WHERE UserID  = @CurrentUserID)

	DECLARE @AssessmentDate DateTime = ( SELECT DateAction AS AssessmentDate From dbo.CaseNeedsAssessment WHERE Id = @NeedsAssessmentID)
	
     IF @BHRIRPID > 0 
	    SELECT IRPID, EpisodeID, @CanEdit AS CanEditIRP, @IsLastBIRPSet AS IsLastBIRPSet,CurrentPhaseStatus, BHRIRPJson, AdditionalRemarks, ActionBy, (SELECT Name FROM [dbo].[fn_GetAsstUserName](ActionBy))ActionName, @AssessmentDate AS AssessmentDate
		  FROM dbo.CaseBHRIRP where IRPID  = @BHRIRPID
     ELSE 
	 BEGIN
	   IF @LBIRPID = 0
	    BEGIN
		DECLARE @Json nvarchar(MAX) = (select '[' + STUFF((
		SELECT ',{"NeedID":"'  + cast(NeedId as varchar(2)) + '"'
		   + ', "NeedName":"' + Name + '"'
		   + ', "NeedLevel": "", "STGoal": "", "PlanedSTInterv": ""'
		   + ', "STGoalMetDate": "", "ReadingForCharge": "", "LTGoal": "", "PlanedLTInterv": ""'
		   + ', "LTGoalMetDate": "", "IdentifiedBarriersToInterventionID":"", "BarrierFrequencyID":""'
		   + '}'
        FROM [dbo].[tlkpCaseNeeds]  for xml path(''), type).value('.', 'nvarchar(max)'), 1, 1, '') + ']')
		SELECT 0 AS IRPID, @EpisodeID AS EpisodeID, @CanEdit AS CanEditIRP, @True AS IsLastBIRPSet, null AS CurrentPhaseStatus,  @Json AS BHRIRPJson,
		'' AS AdditionalRemarks, @CurrentUserID AS ActionBy, 
		(SELECT Name FROM [dbo].[fn_GetAsstUserName](@CurrentUserID))ActionName 	           
		END
	   ELSE
	     SELECT IRPID, EpisodeID, @True AS CanEditIRP, @True AS IsLastBIRPSet,CurrentPhaseStatus, BHRIRPJson, AdditionalRemarks, ActionBy, (SELECT Name FROM [dbo].[fn_GetAsstUserName](ActionBy))ActionName, @AssessmentDate AS AssessmentDate 
		  FROM dbo.CaseBHRIRP where IRPID  = @LBIRPID
     END
     END

  SELECT IBTIID, IBTIValue  FROM [dbo].[tlkpIdentifiedBarriersToIntervention]

  SELECT BarrFreqID, BarrFreqValue  FROM [dbo].[tlkpBarriersFrequency]

END

GO
GRANT EXECUTE ON [dbo].[spGetEpisodeBHRIRP] to [ACCOUNTS\Svc_CDCRBASSSQLWte]
GO
GRANT EXECUTE ON [dbo].[spGetEpisodeBHRIRP] to [ACCOUNTS\Svc_CDCRPATSUser]
GO 
ALTER TABLE dbo.tlkpBarriersFrequency
ADD PRIMARY KEY (BarrFreqID);
GO
ALTER TABLE dbo.tlkpIdentifiedBarriersToIntervention
ADD PRIMARY KEY (IBTIID);
GO
USE [PATSWebV2Test]
GO

/****** Object:  StoredProcedure [dbo].[spGetPATSEpisodeIRPToBASS]    Script Date: 8/9/2022 12:55:43 PM ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

-- =============================================
-- Create date: 2020-03-08
-- Update date: 
-- Description:	Retrive IRP From PATS to BASS
-- =============================================
CREATE PROCEDURE [dbo].[spGetPATSEpisodeIRPToBASS]
    @CDCRNum varchar(6) = '',
	@EpisodeID int  = 0,
	@IRPID int = 0,
	@CurrentUserID int = 0
AS	
BEGIN
   DECLARE @PATSEpisodeID int  = 0
   DECLARE @PATSUserID int = 0
   DECLARE @BassUserID int  = @CurrentUserID
  
   IF @EpisodeID = 0 AND @CDCRNum <> ''
      SET @PATSEpisodeID = (SELECT EpisodeID FROM Episode WHERE CDCRNum = @CDCRNum)
   ELSE IF @EpisodeID > 0
      SET @PATSEpisodeID = @EpisodeID

   --===========================================
   --Add new CDCR
   --===========================================
   IF @PATSEpisodeID = 0
   BEGIN
     DECLARE @PID int  = (SELECT PID FROM [BASSWeb].[dbo].[Episode] E INNER JOIN [BASSWeb].[dbo].[Offender] O ON E.OffenderID = O.OffenderID WHERE CDCRNum = @CDCRNum)
	 IF NOT EXISTS(SELECT PID FROM Offender WHERE PID = @PID)
	 BEGIN
	   INSERT INTO [dbo].[Offender]([MiddleName],[PC290],[PC457],[USVet],[FirstName],
   [LastName],[SSN],[DOB],[GenderID],[MHStatus],[PhysDisabled],[DevDisabled],[PID],[InitialDate] ) 
   SELECT [MiddleName],[PC290],[PC457],[USVet],[FirstName],[LastName],[SSN],[DOB],
    (CASE [GenderID] WHEN 0 THEN 1 WHEN 1 THEN 2 WHEN 2 THEN 3 ELSE 99 END),
    (CASE WHEN EOP = 1 THEN 2 WHEN CCCMS = 1 THEN 3 ELSE NULL END),[PhysDisabled],[DevDisabled],[PID],GetDate() 
	 FROM [BASSWeb].[dbo].[Offender] WHERE PID  = @PID
	 END

	 DECLARE @OffenderID int = (SELECT OffenderID FROM dbo.Offender WHERE PID = @PID)
	 	 
   INSERT INTO [dbo].[Episode]([OffenderID],[SuggestionDate],[InitialDate],[CDCRNum],
     [ReleaseDate],[CustodyFacilityID],[ReleaseCountyID],[Lifer],[ParoleUnit],[ParoleAgent])
   SELECT @OffenderID,[ReferralDate],GetDate(),[CDCRNum],[ReleaseDate],[CustodyFacilityID]
      ,[ReleaseCountyID],[Lifer],[ParoleUnit],[ParoleAgent]
    FROM [BassWeb].[dbo].[Episode] WHERE CDCRNum = @CDCRNum  
	SET @PATSEpisodeID = (SELECT EpisodeID FROM Episode WHERE CDCRNum = @CDCRNum)
	UPDATE EpisodeTrace SET IsLastOne = 0 Where EpisodeID in (SELECT EpisodeID FROM Episode WHERE OffenderID = @OffenderID) 
  INSERT INTO dbo.EpisodeTrace(EpisodeID, IsLastOne, DateAction) VALUES (@PATSEpisodeID, 1, GetDate())
   END

   IF ISNULL(@PATSEpisodeID, 0) > 0
   BEGIN
     IF @IRPID = 0
       SET @IRPID = (SELECT ISNULL(BHRIRPID,0) FROM dbo.EpisodeTrace WHERE EpisodeID  = @PATSEpisodeID)
	 
     IF @IRPID > 0 
	  BEGIN
	   SELECT @BassUserID = ISNULL(BassUserID, 0), @PATSUserID = ActionBy 
		 FROM dbo.CaseBHRIRP WHERE IRPID = @IRPID 
	  END
	  
   END
   EXEC [dbo].[spGetEpisodeBHRIRP] @PATSEpisodeID, @IRPID, @CurrentUserID
   
   SELECT @BassUserID AS BassUserID, (SELECT Name FROM [dbo].[fn_GetAsstUserName](@PATSUserID))PATSUserName
END
GO

GRANT EXECUTE ON [dbo].[spGetPATSEpisodeIRPToBASS] to [ACCOUNTS\Svc_CDCRBASSSQLWte]
GO
GRANT EXECUTE ON [dbo].[spGetPATSEpisodeIRPToBASS] to [ACCOUNTS\Svc_CDCRPATSUser]
GO 